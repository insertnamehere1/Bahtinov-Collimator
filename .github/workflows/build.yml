name: Test Signpath

on:
  workflow_dispatch:

permissions:
  contents: write
  attestations: write
  id-token: write
  security-events: write

jobs:
  build_test:
    name: Build & Test (Windows)
    runs-on: windows-latest
    outputs:
      artifact_id: ${{ steps.upload-artifacts.outputs.artifact-id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: Signpath-Test
          fetch-depth: 0

      - name: Sync ApplicationVersion + AssemblyInfo from tag (no new XML nodes)
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
      
          $raw = $env:GITHUB_REF -replace '^refs/tags/', ''
          $version = $raw -replace '^v', ''
          if ($version -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') { throw "Tag must be vX.Y.Z or vX.Y.Z.W. Got: '$raw'" }
          if ($version -notmatch '^\d+\.\d+\.\d+\.\d+$') { $version = "$version.0" }
          Write-Host "Version from tag: $version"
      
          # Update SkyCal.csproj
          $csproj = 'SkyCal.csproj'
          if (-not (Test-Path $csproj)) { throw "Missing $csproj" }
          $orig = Get-Content -Raw $csproj
          $pattern = '<ApplicationVersion(?<attrs>[^>]*)>\s*.*?\s*</ApplicationVersion>'
          if ($orig -notmatch $pattern) { throw "ApplicationVersion tag not found in $csproj" }
      
          $new = [regex]::Replace(
            $orig,
            $pattern,
            { param($m) "<ApplicationVersion$($m.Groups['attrs'].Value)>$version</ApplicationVersion>" },
            [System.Text.RegularExpressions.RegexOptions]::Singleline
          )
          if ($new -ne $orig) {
            Set-Content -Path $csproj -Value $new -Encoding UTF8
            Write-Host "Updated ApplicationVersion in $csproj"
          } else {
            throw "Regex matched but produced no change in $csproj"
          }
      
          # Update AssemblyInfo.cs
          $ai = 'Properties/AssemblyInfo.cs'
          if (-not (Test-Path $ai)) { throw "Missing $ai" }
          $origAi = Get-Content -Raw $ai
          $updAi = $origAi `
            -replace '\[assembly:\s*AssemblyVersion\(".*?"\)\]',     "[assembly: AssemblyVersion(`"$version`")]" `
            -replace '\[assembly:\s*AssemblyFileVersion\(".*?"\)\]', "[assembly: AssemblyFileVersion(`"$version`")]"
          if ($updAi -ne $origAi) {
            Set-Content -Path $ai -Value $updAi -Encoding UTF8
            Write-Host "Updated AssemblyVersion and AssemblyFileVersion in $ai"
          } else {
            Write-Host "No changes made to $ai"
          }
      
          git add -A
          git diff --staged -- . | Write-Host
          
      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Set up NuGet
        uses: NuGet/setup-nuget@v2

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', '**/packages.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore packages
        run: nuget restore "Bahtinov Collimator.sln"

      - name: Build Release
        run: >
          msbuild "Bahtinov Collimator.sln"
          /t:Rebuild
          /p:Configuration=Release
          /p:Deterministic=true
          /p:TreatWarningsAsErrors=true
          
      # Publish ClickOnce
      - name: ClickOnce Publish
        shell: pwsh
        run: >
          msbuild "SkyCal.csproj"
          /t:Publish
          /p:Configuration=Release
          /p:PublishProfile="Properties\PublishProfiles\ClickOnceProfile.pubxml"
          /p:PublishDir="$(Resolve-Path .)\out\clickonce\"


        - name: Rename ClickOnce setup.exe
          shell: pwsh
          run: |
            if (Test-Path "out\clickonce\setup.exe") {
                Rename-Item "out\clickonce\setup.exe" "SkyCal-Setup.exe" -Force
            }

#      - name: Stage artifacts
#        shell: pwsh
#        run: |
#          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
#          if (Test-Path "out\clickonce\setup.exe") { Copy-Item "out\clickonce\setup.exe" artifacts\setup.exe -Force }
#          Compress-Archive -Path "out\clickonce\*" -DestinationPath "artifacts\SkyCal-clickonce.zip" -Force
#          "@@ Build: $env:GITHUB_RUN_ID`nRef: $env:GITHUB_REF`nSHA: $env:GITHUB_SHA" | Out-File artifacts\BUILD-METADATA.txt -Encoding UTF8

      - name: Stage artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          Copy-Item "out\clickonce\*" "artifacts\" -Recurse -Force
          "@@ Build: $env:GITHUB_RUN_ID`nRef: $env:GITHUB_REF`nSHA: $env:GITHUB_SHA" |
            Out-File artifacts\BUILD-METADATA.txt -Encoding UTF8


      - name: Upload CI artifacts
        id: upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.run_number }}
          path: artifacts/

  codeql:
    name: CodeQL (C# .NET Framework)
    runs-on: windows-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Signpath-Test
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Set up NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore packages
        run: nuget restore "Bahtinov Collimator.sln"

      - name: Build solution for analysis
        run: msbuild "Bahtinov Collimator.sln" /t:Rebuild /p:Configuration=Release /p:Platform="Any CPU"

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  release:
    name: Release (tag only)
    needs: [build_test]
    if: always()
    runs-on: windows-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout Signpath-Test branch
        uses: actions/checkout@v4
        with:
          ref: Signpath-Test
          fetch-depth: 0

      - name: Prepare clean dist/
        shell: pwsh
        run: |
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          New-Item -ItemType Directory -Force -Path dist | Out-Null
        
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output-${{ github.run_number }}
          path: dist




      # Submit once and wait for completion, then use outputs to download the signed ZIP
      - name: Submit to SignPath and wait
        id: sp
        uses: SignPath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: Bahtinov-Collimator
          signing-policy-slug: test-signing
          github-artifact-id: ${{ needs.build_test.outputs.artifact_id }}
          wait-for-completion: true

      - name: Replace unsigned ZIP with signed one
        shell: pwsh
        run: |
          curl -L "${{ steps.SignPath_github_action_submit_signing_request.outputs.signed-artifact-download-url }}" -o SkyCal-clickonce.zip
          tar -xf signed.zip -C signed




      - name: Checksums
        shell: pwsh
        run: |
          cd dist
          Get-ChildItem * | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
            "$hash  $($_.Name)" | Out-File -FilePath SHA256SUMS.txt -Append -Encoding ascii
          }

      - name: SBOM (SPDX) for shipped artifacts
        uses: anchore/sbom-action@v0
        with:
          path: dist
          format: spdx-json
          output-file: dist/sbom.spdx.json

